---
title: "Linear Models"
date: "11/26/2020"
output: github_document
---

```{r setup_and_data_visualization_preferences}
library(tidyverse)
library(patchwork)
library(stringr)
library(p8105.datasets)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Data import and tidying

```{r}
data("nyc_airbnb")

nyc_airbnb = 
  nyc_airbnb %>% 
  mutate(stars = review_scores_location / 2) %>% 
  rename(
    borough = neighbourhood_group,
    neighborhood = neighbourhood
  ) %>% 
  filter(borough != "Staten Island") %>% 
  select(price, stars, borough, neighborhood, room_type)
```

## Fit a model

Want to know how price of rental is related to stars and borough

```{r}
nyc_airbnb %>% 
  ggplot(aes(x = stars, y = price, color = borough)) + 
  geom_point()
```

Want to fit a model to this

```{r}
price_fit = lm(price ~ stars + borough, data = nyc_airbnb)
```

Lets look at model results generically

```{r in}
price_fit

#This gives a fair bit of info
summary(price_fit)

#This one give t statistic and p-value for each individual coefficient
summary(price_fit)$coef
```

```{r include = FALSE}
#These outputs do not seem useful
coef(price_fit)
fitted.values(price_fit)
residuals(price_fit)
```


Tidy results of fit

```{r}
broom::glance(price_fit)

broom::tidy(price_fit)
```

For every one-unit increase in stars, price of room increases by $32 keeping borough fixed.
Implicitly ref group is Bronx (first alphabetical). Room in Manhattan is $90 more than in Bronx.

Get test stat for each and p-value

Queens is not statistically significant

```{r}
broom::tidy(price_fit) %>% 
  select(-std.error, -statistic) %>% 
  mutate(
    term = str_replace(term, "borough", "Borough: ")
  ) %>% 
  knitr::kable()
```


## Be in control of factors

Character variables get converted to factor variables in R. Preserve text, but add structure of 1, 2, 3, 4, 5, etc... to it. R makes an assumption that it should be in alphabetical order, which then gets put into indicator variables. First one alphabetically will be reference group 

Make ref category the most common one.

```{r}
nyc_airbnb =
  nyc_airbnb %>% 
  mutate(
    borough = fct_infreq(borough),
    room_type = fct_infreq(room_type)
  )

nyc_airbnb %>% 
  ggplot(aes(x = stars, y = price, color = borough)) + 
  geom_point()
```

```{r}
price_fit = lm(price ~ stars + borough, data = nyc_airbnb)

broom::tidy(price_fit)
broom::glance(price_fit)
```

Now, Brooklyn is being compared to Manhattan, Bronx to Manhattan etc. This doesn't change model intrinsically, just changes what you see and how it works

## Diagnostics

```{r}
modelr::add_residuals(nyc_airbnb, price_fit)
```

This looks like usual df, but shows that for each observation, e.g., the first room is $9.47 more than expected

```{r}
modelr::add_residuals(nyc_airbnb, price_fit) %>% 
  ggplot(aes(x = borough, y = resid)) + 
  geom_violin()
```

This is a distribution of residuals... shows some significnat outliers in the model

```{r}
nyc_airbnb %>% 
  modelr::add_residuals(price_fit) %>% 
  ggplot(aes(x = borough, y = resid)) + 
  geom_violin() + 
  ylim(-500, 1500)

nyc_airbnb %>% 
  modelr::add_residuals(price_fit) %>% 
  ggplot(aes(x = stars, y = resid)) + 
  geom_point() + 
  facet_wrap(. ~borough)
```

There is a problem in that there are these big outliers in residual distribution, suggests that model may not be appropriate.

Second plot shows that there are more outliers at higher star ratings (extremely high priced apartments) that limit how well the model works.

## Hypothesis tests

```{r}
price_fit %>% 
  broom::tidy()
```

This does t-test by default for each coefficient.

What if we want to test the significance of `borough` all together... use F test (ANOVA)

```{r}
fit_null = lm(price ~ stars, data = nyc_airbnb)
fit_alt = lm(price ~ stars + borough, data = nyc_airbnb)

anova(fit_null, fit_alt) %>% 
  broom::tidy()
```

If do F-test first, and then do t-test after that then worry about multiple comparisons corrections being stats problem
